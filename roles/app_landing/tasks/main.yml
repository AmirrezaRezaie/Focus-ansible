- name: Ensure landing directory exists on VM
  ansible.builtin.file:
    path: "{{ app_dest }}"
    state: directory
    mode: "0755"

- name: Check stack.yml exists on control machine
  ansible.builtin.stat:
    path: "{{ app_src }}/stack.yml"
  delegate_to: localhost
  become: false
  register: stack_stat

- name: Fail if stack.yml is missing on control machine
  ansible.builtin.fail:
    msg: "stack.yml not found: {{ app_src }}/stack.yml"
  when: not stack_stat.stat.exists
  delegate_to: localhost
  become: false

- name: Copy stack.yml to VM
  ansible.builtin.copy:
    src: "{{ app_src }}/stack.yml"
    dest: "{{ app_dest }}/stack.yml"
    mode: "0644"

- name: Ensure Docker Swarm is active
  ansible.builtin.command: docker info --format '{{ "{{" }} .Swarm.LocalNodeState {{ "}}" }}'
  register: swarm_state
  changed_when: false

- name: Fail if swarm is not active
  ansible.builtin.fail:
    msg: "Docker Swarm is not active on this node. Run: docker swarm init --advertise-addr <SERVER_IP>"
  when: swarm_state.stdout != "active"

- name: Ensure overlay network exists (goalixa_net)
  ansible.builtin.command: docker network create --driver overlay --attachable goalixa_net
  register: net_create
  changed_when: net_create.rc == 0
  failed_when: net_create.rc != 0 and ("already exists" not in (net_create.stderr | lower))

# Deploy stack (resolve image so latest update actually applies)
- name: Deploy landing stack
  ansible.builtin.command: docker stack deploy --resolve-image always -c "{{ app_dest }}/stack.yml" goalixa
  register: deploy_out
  changed_when: true

- name: Force update landing service
  ansible.builtin.command: docker service update --force goalixa_landing
  changed_when: true

- name: Show stack services
  ansible.builtin.command: docker stack services goalixa
  register: stack_services
  changed_when: false

- name: Print stack services
  ansible.builtin.debug:
    var: stack_services.stdout_lines
