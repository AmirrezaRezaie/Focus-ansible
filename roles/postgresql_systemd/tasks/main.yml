- name: Resolve PostgreSQL settings for OS family
  set_fact:
    postgres_packages: "{{ postgres_packages_map[ansible_os_family] | default(postgres_packages_map['Debian']) }}"
    postgres_service: "{{ postgres_service_map[ansible_os_family] | default(postgres_service_map['Debian']) }}"
    postgres_initdb_command: "{{ postgres_initdb_command_map[ansible_os_family] | default('') }}"
    postgres_initdb_marker: "{{ postgres_initdb_marker_map[ansible_os_family] | default('') }}"

- name: Install PostgreSQL packages
  package:
    name: "{{ postgres_packages }}"
    state: present

- name: Initialize PostgreSQL data directory when required
  command: "{{ postgres_initdb_command }}"
  args:
    creates: "{{ postgres_initdb_marker }}"
  when:
    - postgres_initdb_command | length > 0
    - postgres_initdb_marker | length > 0

- name: Ensure PostgreSQL service is enabled and running
  service:
    name: "{{ postgres_service }}"
    enabled: true
    state: started

- name: Wait for PostgreSQL to accept connections
  wait_for:
    host: 127.0.0.1
    port: 5432
    state: started
    delay: 2
    timeout: 30

- name: Locate PostgreSQL socket file
  shell: |
    set -e
    for dir in {{ postgres_socket_search_paths | map('quote') | join(' ') }}; do
      if [ -d "$dir" ]; then
        found=$(find "$dir" -type s -name ".s.PGSQL.5432" -print -quit 2>/dev/null || true)
        if [ -n "$found" ]; then
          echo "$found"
          exit 0
        fi
      fi
    done
    exit 1
  register: postgres_socket_cmd
  changed_when: false
  failed_when: false

- name: Use detected PostgreSQL socket directory when available
  set_fact:
    postgres_unix_socket: "{{ postgres_socket_cmd.stdout | trim | dirname }}"
  when: postgres_socket_cmd.stdout | trim | length > 0

- name: Fail if PostgreSQL socket is missing
  fail:
    msg: "PostgreSQL socket not found in {{ postgres_socket_search_paths }}; verify the service is running."
  when: postgres_socket_cmd.stdout | trim | length == 0

- name: Ensure PostgreSQL user exists
  community.postgresql.postgresql_user:
    name: "{{ postgres_user }}"
    password: "{{ postgres_password }}"
    login_unix_socket: "{{ postgres_unix_socket }}"
    state: present
  become_user: postgres

- name: Ensure PostgreSQL database exists
  community.postgresql.postgresql_db:
    name: "{{ postgres_db }}"
    owner: "{{ postgres_user }}"
    login_unix_socket: "{{ postgres_unix_socket }}"
    state: present
  become_user: postgres
